<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product
    Id="*"
    Name="UniFi-Doordeck Bridge"
    Language="1033"
    Version="0.1.0"
    Manufacturer="Tech Tap Solutions"
    UpgradeCode="E9C5E5F9-8B5A-4A5E-9F3E-5C8D7F6E4D3C">

    <Package
      InstallerVersion="200"
      Compressed="yes"
      InstallScope="perMachine"
      Description="UniFi-Doordeck Bridge Installer"
      Comments="Bridges UniFi Access with Doordeck Cloud"
      Manufacturer="Tech Tap Solutions"/>

    <MajorUpgrade DowngradeErrorMessage="A newer version of UniFi-Doordeck Bridge is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Installation directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">

      <!-- Program Files -->
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="UniFi-Doordeck-Bridge">

          <!-- Main application files -->
          <Component Id="MainApplication" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">
            <File Id="PackageJson" Source="..\package.json" KeyPath="yes" />
            <File Id="PackageLock" Source="..\package-lock.json" />
            <File Id="LicenseFile" Source="..\LICENSE" />
            <File Id="ReadmeFile" Source="..\README.md" />
          </Component>

          <!-- Dist folder with all built files -->
          <Directory Id="DistFolder" Name="dist">
            <Component Id="DistFiles" Guid="B2C3D4E5-F6A7-8901-BCDE-F12345678901">
              <File Id="IndexJs" Source="..\dist\index.js" />
              <!-- Add more dist files as needed -->
            </Component>
          </Directory>

          <!-- Scripts folder -->
          <Directory Id="ScriptsFolder" Name="scripts">
            <Component Id="ScriptFiles" Guid="C3D4E5F6-A7B8-9012-CDEF-123456789012">
              <File Id="InstallServiceJs" Source="..\scripts\install-service.js" />
              <File Id="UninstallServiceJs" Source="..\scripts\uninstall-service.js" />
            </Component>
          </Directory>

        </Directory>
      </Directory>

      <!-- ProgramData directory for config and logs -->
      <Directory Id="CommonAppDataFolder">
        <Directory Id="DataFolder" Name="UniFi-Doordeck-Bridge">
          <Component Id="DataDirectory" Guid="D4E5F6A7-B8C9-0123-DEFG-234567890123">
            <CreateFolder>
              <Permission User="Everyone" GenericAll="yes" />
            </CreateFolder>
            <File Id="ConfigExample" Source="..\config.example.json" Name="config.json" />

            <!-- Logs subfolder -->
            <Directory Id="LogsFolder" Name="logs">
              <Component Id="LogsDirectory" Guid="E5F6A7B8-C9D0-1234-EFGH-345678901234">
                <CreateFolder>
                  <Permission User="Everyone" GenericAll="yes" />
                </CreateFolder>
              </Component>
            </Directory>
          </Component>
        </Directory>
      </Directory>

      <!-- Start Menu shortcuts -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="UniFi-Doordeck Bridge">
          <Component Id="StartMenuShortcuts" Guid="F6A7B8C9-D0E1-2345-FGHI-456789012345">

            <!-- Configure shortcut -->
            <Shortcut
              Id="ConfigShortcut"
              Name="Configure"
              Target="[SystemFolder]notepad.exe"
              Arguments="&quot;[DataFolder]config.json&quot;"
              WorkingDirectory="DataFolder"
              Icon="ConfigIcon"
            />

            <!-- View Logs shortcut -->
            <Shortcut
              Id="ViewLogsShortcut"
              Name="View Logs"
              Target="[SystemFolder]explorer.exe"
              Arguments="&quot;[DataFolder]logs&quot;"
              WorkingDirectory="DataFolder"
              Icon="LogsIcon"
            />

            <!-- Start Service shortcut -->
            <Shortcut
              Id="StartServiceShortcut"
              Name="Start Service"
              Target="[SystemFolder]sc.exe"
              Arguments="start &quot;UniFi-Doordeck-Bridge&quot;"
              Icon="StartIcon"
            />

            <!-- Stop Service shortcut -->
            <Shortcut
              Id="StopServiceShortcut"
              Name="Stop Service"
              Target="[SystemFolder]sc.exe"
              Arguments="stop &quot;UniFi-Doordeck-Bridge&quot;"
              Icon="StopIcon"
            />

            <!-- Service Manager shortcut -->
            <Shortcut
              Id="ServiceManagerShortcut"
              Name="Service Manager"
              Target="[SystemFolder]services.msc"
              Icon="ServicesIcon"
            />

            <!-- Uninstall shortcut -->
            <Shortcut
              Id="UninstallShortcut"
              Name="Uninstall"
              Target="[SystemFolder]msiexec.exe"
              Arguments="/x [ProductCode]"
              Icon="UninstallIcon"
            />

            <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
            <RegistryValue Root="HKCU" Key="Software\UniFi-Doordeck-Bridge" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
          </Component>
        </Directory>
      </Directory>
    </Directory>

    <!-- Icons -->
    <Icon Id="ConfigIcon" SourceFile="$(var.SystemFolder)notepad.exe" />
    <Icon Id="LogsIcon" SourceFile="$(var.SystemFolder)explorer.exe" />
    <Icon Id="StartIcon" SourceFile="$(var.SystemFolder)sc.exe" />
    <Icon Id="StopIcon" SourceFile="$(var.SystemFolder)sc.exe" />
    <Icon Id="ServicesIcon" SourceFile="$(var.SystemFolder)mmc.exe" />
    <Icon Id="UninstallIcon" SourceFile="$(var.SystemFolder)msiexec.exe" />

    <!-- Features to install -->
    <Feature Id="ProductFeature" Title="UniFi-Doordeck Bridge" Level="1" Description="Core bridge application">
      <ComponentRef Id="MainApplication" />
      <ComponentRef Id="DistFiles" />
      <ComponentRef Id="ScriptFiles" />
      <ComponentRef Id="DataDirectory" />
      <ComponentRef Id="LogsDirectory" />
      <ComponentRef Id="StartMenuShortcuts" />
    </Feature>

    <!-- Custom actions for service installation -->
    <CustomAction Id="InstallService"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[SystemFolder]cmd.exe /c node scripts\install-service.js"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <CustomAction Id="UninstallService"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[SystemFolder]cmd.exe /c node scripts\uninstall-service.js"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <!-- Installation sequence -->
    <InstallExecuteSequence>
      <Custom Action="InstallService" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="UninstallService" Before="RemoveFiles">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
    </InstallExecuteSequence>

    <!-- UI -->
    <UIRef Id="WixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <!-- License -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!-- Product icon -->
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Icon Id="ProductIcon" SourceFile="$(var.SystemFolder)msiexec.exe" />

  </Product>
</Wix>
